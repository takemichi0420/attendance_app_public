{% extends "base.html" %}

{% block title %}スタッフ設定{% endblock %}

{% block content %}
<nav class="navbar navbar-expand-lg navbar-light bg-light px-3 mb-4">
  <h1 class="navbar-brand fw-bold">スタッフ設定</h1>
  <div class="ms-auto d-flex gap-2">
    <a href="{% url 'payroll:payroll_config' %}" class="btn btn-outline-primary btn-sm">給与設定</a>
    <a href="{% url 'payroll:staff_list' %}" class="btn btn-outline-success btn-sm">給与一覧へ</a>

    <a href="{% url 'attendance:staff_create' %}" class="btn btn-success btn-sm">＋新規スタッフ</a>
    <a href="{% url 'attendance:retired_staff_list' %}" class="btn btn-success btn-sm">退職者一覧</a>

    <form method="post" action="{% url 'attendance:logout' %}">
      {% csrf_token %}
      <input type="hidden" name="next" value="{% url 'attendance:qr_top' %}">
      <button type="submit" class="btn btn-outline-danger btn-sm">ログアウト</button>
    </form>
  </div>
</nav>

<p><a href="{% url 'attendance:qr_top' %}">← トップへ</a></p>

<!-- 検索フォーム -->
<form method="get" class="mb-3 d-flex gap-2">
  <input type="text" name="q" value="{{ q }}" class="form-control col-md-4" placeholder="スタッフ名を検索">
  <button class="btn btn-primary btn-lg">検索</button>
  {% if q %}
    <a href="{% url 'attendance:staff_list' %}" class="btn btn-secondary btn-sm">クリア</a>
  {% endif %}
</form>

<!-- 給与種別フィルター -->
<form method="get" class="mb-4">
  <div class="btn-group">
    <a href="{% url 'attendance:staff_list' %}"
       class="btn btn-outline-primary {% if not request.GET.wage %}active{% endif %}">すべて</a>
    <a href="?wage=hourly"
       class="btn btn-outline-primary {% if request.GET.wage == 'hourly' %}active{% endif %}">時給</a>
    <a href="?wage=salary"
       class="btn btn-outline-primary {% if request.GET.wage == 'salary' %}active{% endif %}">固定給</a>
  </div>
</form>

<!-- 一括操作用フォーム（選択→削除/QR再生成） -->
<form method="post">
  {% csrf_token %}

  <div class="d-flex mb-2">
    <select name="bulk_action" class="form-select w-auto me-2">
      <option value="">一括操作を選択</option>
      <option value="delete">選択スタッフを削除</option>
      <option value="regen_qr">QR コードを再生成</option>
    </select>
    <button type="submit" class="btn btn-primary">実行</button>
  </div>

  <div class="card shadow-sm bg-white rounded">
    <div class="card-body p-3">
      <table class="table table-striped table-bordered mb-0">
    <thead>
      <tr>
        <th><input type="checkbox" id="check-all"></th>
        <th>ID</th>
        <th>スタッフ名</th>
        <th>QR</th>
        <th>トークン</th>
        <th>時給 / 固定給</th>
      </tr>
    </thead>
    <tbody>
      {% for staff in staffs %}
      <tr>
        <td class="text-center">
          <input type="checkbox"
                 name="selected_profiles"
                 value="{{ staff.profile.pk|default_if_none:'' }}"
                 class="staff-check"
                 {% if not staff.profile %}disabled{% endif %}>
        </td>

        <td>{{ staff.id|stringformat:"03d" }}</td>

        <td>
          {% if staff.profile %}
            <a href="{% url 'payroll:payroll_staff_detail' staff.pk %}">{{ staff.name }}</a>
            <a href="{% url 'attendance:staff_logs' staff.pk %}" class="btn btn-outline-primary btn-sm ms-2">Log</a>
          {% else %}
            {{ staff.name }}
          {% endif %}
        </td>
        
        <td>
          {% if staff.profile and staff.profile.qr_image %}
            <a href="#"
               class="qr-link"
               data-url="{% url 'attendance:staff_qr_detail' staff.profile.pk %}">
              <img src="{{ staff.profile.qr_image.url }}?v={{ staff.profile.qr_token }}" width="50" alt="QR">
            </a>
          {% else %}
            —
          {% endif %}
        </td>

        <td>
          {% if staff.profile and staff.profile.qr_token %}
            {{ staff.profile.qr_token }}
          {% else %}
            —
          {% endif %}
        </td>

        <td>
          {% if staff.wage_type == 'hourly' %}
            ¥{{ staff.hourly_rate|floatformat:0|yenfmt }}
          {% else %}
            ¥{{ staff.monthly_salary|floatformat:0|yenfmt }}
          {% endif %}
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="6" class="text-center">スタッフが登録されていません</td>
      </tr>
      {% endfor %}
    </tbody>
      </table>
    </div>
  </div>
</form>

<script>
// 全選択
document.getElementById('check-all').addEventListener('click', e => {
  document.querySelectorAll('input[name="selected_profiles"]').forEach(cb => {
    if (!cb.disabled) cb.checked = e.target.checked;
  });
});

// QR画像ポップアップ
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.qr-link').forEach(link => {
    link.addEventListener('click', e => {
      e.preventDefault();
      window.open(
        link.dataset.url,
        'QRWindow',
        'width=400,height=400,menubar=no,toolbar=no,scrollbars=yes,resizable=yes'
      );
    });
  });
});
</script>
{% endblock %}